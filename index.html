<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íŒ€ ì •ì‚° ì–´í”Œ</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { 
            --primary: #4a90e2; 
            --bg: #f4f7f9; 
            --card-bg: #ffffff; 
            --danger: #ff4d4f; 
            --success: #28a745; 
            --dark: #2d3436; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            padding: 12px; 
            margin: 0; 
            color: #333; 
            -webkit-tap-highlight-color: transparent; 
        }

        /* ì „ì²´ ì»¨í…Œì´ë„ˆ: ìµœëŒ€ ë„ˆë¹„ë¥¼ ì¤„ì´ê³  ì–‘ì˜† ì—¬ë°± í™•ë³´ */
        .container { 
            max-width: 450px; 
            margin: 0 auto; 
            padding-bottom: 40px; 
        }

        .card { 
            background: var(--card-bg); 
            padding: 16px; 
            border-radius: 16px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.06); 
            margin-bottom: 15px; 
        }

        h2 { 
            margin-top: 0; 
            font-size: 1.1rem; 
            border-bottom: 1px solid #f1f3f5; 
            padding-bottom: 12px; 
            text-align: center;
            letter-spacing: -0.5px;
        }

        .item-group { 
            border: 1px solid #eee; 
            border-radius: 12px; 
            margin-bottom: 10px; 
            overflow: hidden; 
            background: #fff; 
            position: relative; 
        }

        /* ìš”ì•½ í—¤ë”: ë†’ì´ë¥¼ ì¤„ì—¬ ì‹œê°ì  ë¶€ë‹´ ê°ì†Œ */
        .item-header { 
            padding: 12px 40px 12px 12px; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            gap: 2px; 
            background: #fff; 
        }

        .item-body { 
            padding: 15px; 
            display: block; 
            border-top: 1px solid #eee; 
            background: #fafafa; 
        }

        .collapsed .item-body { display: none; }

        .remove-btn { 
            position: absolute; right: 8px; top: 10px; 
            background: #f1f3f5; color: #adb5bd; 
            width: 26px; height: 26px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 18px; border: none; z-index: 5; cursor: pointer; 
        }

        /* ì…ë ¥ì°½ ìŠ¬ë¦¼í™” */
        input[type="text"] { 
            width: 100%; 
            padding: 12px; 
            margin: 6px 0; 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            box-sizing: border-box; 
            font-size: 0.95rem; 
            appearance: none;
        }

        .label-text { 
            font-size: 0.8rem; 
            font-weight: bold; 
            margin-top: 12px; 
            display: block; 
            color: #777; 
        }

        .flex-group { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }

        /* ì„ íƒ ë²„íŠ¼ë“¤ì„ ë” ì‘ê³  ê¹”ë”í•˜ê²Œ */
        .radio-item, .check-item { 
            font-size: 0.8rem; 
            background: #fff; 
            border: 1px solid #e0e0e0; 
            padding: 8px 12px; 
            border-radius: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 4px;
        }

        button { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 1rem; 
            transition: background 0.2s; 
        }

        button:active { opacity: 0.8; transform: scale(0.98); }

        .save-btn { background: var(--success); color: white; margin-top: 10px; font-size: 0.9rem; padding: 12px; }
        .add-btn { background: #495057; color: white; margin-bottom: 8px; }
        .clear-btn { background: #f1f3f5; color: #adb5bd; margin-bottom: 8px; padding: 10px; font-size: 0.85rem; }
        .calc-btn { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2); }
        .image-btn { background: #6c5ce7; color: white; margin-top: 15px; }

        /* ë¦¬í¬íŠ¸ ë°•ìŠ¤ ìµœì í™” */
        .result-box { 
            background: var(--dark); 
            color: #fff; 
            padding: 20px; 
            border-radius: 18px; 
            display: none; 
            margin-top: 20px; 
        }

        .report-table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 0.8rem; color: #eee; }
        .report-table th { border-bottom: 1px solid #444; padding: 8px; text-align: left; color: #999; }
        .report-table td { padding: 8px; border-bottom: 1px solid #3d4446; }
        .highlight { color: #f39c12; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>ğŸ§¾ íŒ€ ì •ì‚° ì–´í”Œ</h2>
        <div id="itemList"></div>
        <button class="add-btn" onclick="addNewItem()">+ ìƒˆë¡œìš´ ì°¨ìˆ˜ ì¶”ê°€</button>
        <button class="clear-btn" onclick="clearAllItems()">ğŸ—‘ï¸ ëª¨ë“  ë‚´ì—­ ì§€ìš°ê¸°</button>
        <button class="calc-btn" onclick="calculate()">ğŸš€ ì •ì‚° ê²°ê³¼ í™•ì¸</button>
    </div>

    <div id="captureArea">
        <div id="result" class="result-box card">
            <h3 style="color:white; margin-top:0; text-align:center; font-size:1.1rem;">ğŸ“Š ìµœì¢… ì •ì‚° ë¦¬í¬íŠ¸</h3>
            <div id="reportHeader"></div>
            <div id="reportGuide"></div>
            <div id="privateSection"></div>
        </div>
    </div>
    
    <div id="actionButtons" style="display:none;">
        <button class="image-btn" onclick="saveAsImage()">ğŸ–¼ï¸ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<script>
    const teamNames = { A: "AíŒ€(ì˜ì„±,ì§€í˜œ)", B: "BíŒ€(í˜„ìˆ˜,ë¯¸ì˜)", C: "CíŒ€(ì§€í›ˆ,ì€í˜œ)" };

    window.onload = function() {
        const savedData = localStorage.getItem('settlementData');
        if (savedData) {
            JSON.parse(savedData).forEach((item) => renderItem(item));
        } else {
            addNewItem();
        }
    }

    function renderItem(data = null) {
        const tempId = Date.now() + Math.random();
        const div = document.createElement('div');
        div.className = `item-group ${data?.collapsed ? 'collapsed' : ''}`;
        div.setAttribute('data-id', tempId);
        
        div.innerHTML = `
            <button class="remove-btn" onclick="removeItem(this)">Ã—</button>
            <div class="item-header" onclick="toggleItem(this)">
                <span style="font-weight:bold; font-size:0.95rem;" class="title-text">...</span>
                <div style="font-size:0.75rem; color:#888; line-height:1.4;" class="sub-text"></div>
            </div>
            <div class="item-body">
                <input type="text" placeholder="í•­ëª©ëª… (ì˜ˆ: ê°ìíƒ•)" class="item-name" value="${data?.name || ''}" oninput="updateHeader(this)">
                <input type="text" placeholder="ê²°ì œ ê¸ˆì•¡" class="item-amount" inputmode="numeric" value="${data?.amount || ''}" oninput="formatAmount(this); updateHeader(this)">
                <span class="label-text">ğŸ’³ ëˆ„ê°€ ê²°ì œí–ˆë‚˜ìš”? (í•„ìˆ˜)</span>
                <div class="flex-group">
                    ${[teamNames.A, teamNames.B, 'ì§€í›ˆ', 'ì€í˜œ'].map(p => `
                        <label class="radio-item"><input type="radio" name="payer_${tempId}" value="${p}" ${data?.payer === p ? 'checked' : ''} onchange="updateHeader(this)">${p}</label>
                    `).join('')}
                </div>
                <span class="label-text">ğŸ‘¥ ì°¸ì—¬í•œ íŒ€ ì„ íƒ</span>
                <div class="flex-group">
                    <label class="check-item"><input type="checkbox" class="team-a" ${data?.teams?.A !== false ? 'checked' : ''} onchange="updateHeader(this)">${teamNames.A}</label>
                    <label class="check-item"><input type="checkbox" class="team-b" ${data?.teams?.B !== false ? 'checked' : ''} onchange="updateHeader(this)">${teamNames.B}</label>
                    <label class="check-item"><input type="checkbox" class="team-c" ${data?.teams?.C !== false ? 'checked' : ''} onchange="updateHeader(this)">${teamNames.C}</label>
                </div>
                <button class="save-btn" onclick="saveAndCollapse(this)">âœ” ì´ ë‚´ì—­ ì €ì¥ ë° ì ‘ê¸°</button>
            </div>
        `;
        document.getElementById('itemList').appendChild(div);
        updateHeader(div.querySelector('.item-name'));
    }

    function updateHeader(element) {
        const g = element.closest('.item-group');
        const nameInput = g.querySelector('.item-name').value;
        const amt = g.querySelector('.item-amount').value || "0";
        const payer = g.querySelector(`input[type="radio"]:checked`)?.value || "ë¯¸ì„ íƒ";
        
        const teams = [];
        if(g.querySelector('.team-a').checked) teams.push("A");
        if(g.querySelector('.team-b').checked) teams.push("B");
        if(g.querySelector('.team-c').checked) teams.push("C");

        const allGroups = Array.from(document.querySelectorAll('.item-group'));
        const index = allGroups.indexOf(g) + 1;
        const finalName = nameInput || index + "ì°¨";

        g.querySelector('.title-text').innerText = `${finalName} (${amt}ì›)`;
        g.querySelector('.sub-text').innerHTML = `ê²°ì œ: <b>${payer}</b> | ì°¸ì—¬: <b>${teams.join(', ')}íŒ€</b>`;
        
        saveToLocal();
    }

    function formatAmount(obj) {
        let value = obj.value.replace(/[^0-9]/g, "");
        obj.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function addNewItem() { renderItem(); }

    function clearAllItems() {
        if(confirm("ëª¨ë“  ì •ì‚° ë‚´ì—­ì„ ì§€ìš°ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem('settlementData');
            document.getElementById('itemList').innerHTML = "";
            document.getElementById('result').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            addNewItem();
        }
    }

    function saveAndCollapse(btn) {
        const g = btn.closest('.item-group');
        g.classList.add('collapsed');
        saveToLocal();
    }

    function saveToLocal() {
        const items = [];
        document.querySelectorAll('.item-group').forEach(g => {
            const tempId = g.getAttribute('data-id');
            items.push({
                name: g.querySelector('.item-name').value,
                amount: g.querySelector('.item-amount').value,
                payer: g.querySelector(`input[name="payer_${tempId}"]:checked`)?.value || "",
                teams: { 
                    A: g.querySelector('.team-a').checked, 
                    B: g.querySelector('.team-b').checked, 
                    C: g.querySelector('.team-c').checked 
                },
                collapsed: g.classList.contains('collapsed')
            });
        });
        localStorage.setItem('settlementData', JSON.stringify(items));
    }

    function toggleItem(header) { header.closest('.item-group').classList.toggle('collapsed'); }
    function removeItem(btn) { if(confirm("ì´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { btn.closest('.item-group').remove(); saveToLocal(); } }

    function calculate() {
        saveToLocal();
        const items = JSON.parse(localStorage.getItem('settlementData') || "[]");
        const invalid = items.find(i => !i.payer || i.amount === "0" || !i.amount);
        if (invalid) return alert("ê²°ì œ ì •ë³´ê°€ ë¶€ì¡±í•œ ì°¨ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤. í™•ì¸í•´ì£¼ì„¸ìš”!");

        let total = 0, teamPaid = { A: 0, B: 0, C: 0 }, teamSpent = { A: 0, B: 0, C: 0 }, indC = { ì§€í›ˆ: 0, ì€í˜œ: 0 };
        let tableHtml = `<table class="report-table"><tr><th>í•­ëª©</th><th>ê²°ì œì</th><th>ê¸ˆì•¡</th></tr>`;

        items.forEach((item, idx) => {
            const amt = Number(item.amount.replace(/,/g,''));
            total += amt;
            const displayName = item.name || (idx + 1) + "ì°¨";
            tableHtml += `<tr><td>${displayName}</td><td>${item.payer}</td><td>${amt.toLocaleString()}ì›</td></tr>`;

            if(item.payer.includes('AíŒ€')) teamPaid.A += amt;
            else if(item.payer.includes('BíŒ€')) teamPaid.B += amt;
            else { 
                teamPaid.C += amt; 
                if(item.payer === 'ì§€í›ˆ') indC.ì§€í›ˆ += amt; 
                if(item.payer === 'ì€í˜œ') indC.ì€í˜œ += amt; 
            }

            const active = Object.keys(item.teams).filter(k => item.teams[k]);
            active.forEach(t => teamSpent[t] += (amt / active.length));
        });

        tableHtml += `</table>`;

        let diff = [{n:teamNames.A, v:teamPaid.A-teamSpent.A}, {n:teamNames.B, v:teamPaid.B-teamSpent.B}, {n:teamNames.C, v:teamPaid.C-teamSpent.C}];
        let msg = "";
        diff.filter(d => d.v < 0).forEach(d => {
            let debt = Math.abs(d.v);
            diff.filter(c => c.v > 0).forEach(c => {
                if(debt <= 0 || c.v <= 0) return;
                let p = Math.min(debt, c.v);
                msg += `<div style="margin-bottom:8px;">ğŸ’° <span class="highlight">${d.n} â†’ ${c.n}</span><br><span style="margin-left:25px;">${Math.round(p).toLocaleString()}ì›</span></div>`;
                debt -= p; c.v -= p;
            });
        });

        const toSendC = (teamSpent.C/2) - indC.ì€í˜œ;
        
        document.getElementById('reportHeader').innerHTML = `
            <div style="font-size:0.85rem; margin-bottom:5px; border-bottom:1px solid #555; padding-bottom:5px; color:#adb5bd;">ğŸ“ ì§€ì¶œ ë‚´ì—­ ìƒì„¸</div>
            ${tableHtml}
            <div style="text-align:right; font-weight:bold; margin-bottom:20px; color:#f39c12; font-size:1rem;">ì´ì•¡: ${total.toLocaleString()}ì›</div>
        `;
        
        document.getElementById('reportGuide').innerHTML = `
            <div style="font-size:0.85rem; margin-bottom:8px; color:#adb5bd;">ğŸ“ ìµœì¢… ì†¡ê¸ˆ ê°€ì´ë“œ</div>
            <div style="background:#3d4446; padding:15px; border-radius:12px; font-size:0.9rem; line-height:1.6;">
                ${msg || "ëª¨ë‘ ì •ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤."}
            </div>
        `;

        document.getElementById('privateSection').innerHTML = `
            <hr style="border:0; border-top:1px dashed #555; margin:15px 0;">
            <div style="font-size:0.75rem; color:#888; margin-bottom:5px;">[CíŒ€ ë‚´ë¶€ ì •ì‚°]</div>
            <div style="font-size:0.9rem;">${toSendC > 0 ? 'ì€í˜œ â†’ ì§€í›ˆ' : 'ì§€í›ˆ â†’ ì€í˜œ'}: <span class="highlight">${Math.round(Math.abs(toSendC)).toLocaleString()}ì›</span></div>
        `;

        document.getElementById('result').style.display = 'block';
        document.getElementById('actionButtons').style.display = 'block';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function saveAsImage() {
        const privateSection = document.getElementById('privateSection');
        privateSection.style.display = 'none';
        
        const area = document.getElementById('captureArea');
        html2canvas(area, {
            backgroundColor: "#f4f7f9",
            scale: 2
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `ì •ì‚°ë¦¬í¬íŠ¸_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL();
            link.click();
            privateSection.style.display = 'block';
        });
    }
</script>
</body>
</html>
