<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium íŒ€ ì •ì‚° v8</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #5c67f2;
            --bg: #f8f9fd;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --danger: #ff7675;
            --accent: #fdcb6e;
        }

        body { 
            font-family: 'Pretendard', -apple-system, sans-serif; 
            background: var(--bg); padding: 20px 15px; margin: 0; 
            color: var(--text-main); -webkit-font-smoothing: antialiased;
        }

        .container { max-width: 480px; margin: 0 auto; }

        .card { 
            background: var(--card-bg); padding: 20px; border-radius: 24px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.04); margin-bottom: 20px;
        }

        h2 { margin: 0 0 20px 0; font-size: 1.25rem; text-align: center; font-weight: 800; }

        /* ì…ë ¥ì°½ ë²„ê·¸ ìˆ˜ì • */
        .input-field {
            width: 100%; 
            box-sizing: border-box; /* ë„ˆë¹„ ê³„ì‚°ì— íŒ¨ë”© í¬í•¨ */
            padding: 14px 15px; 
            margin: 8px 0; 
            border: 1.5px solid #edf2f7; 
            border-radius: 14px; 
            font-size: 1rem;
            display: block;
        }

        .item-group { 
            border: 1.5px solid #f1f3f5; border-radius: 20px; 
            margin-bottom: 12px; background: #fff; position: relative; overflow: hidden;
        }
        
        .item-header { padding: 18px; cursor: pointer; display: flex; flex-direction: column; gap: 6px; }
        .title-text { font-size: 1rem; font-weight: 700; color: var(--text-main); }
        .sub-text { font-size: 0.75rem; color: var(--text-sub); line-height: 1.4; }

        .item-body { padding: 0 18px 20px 18px; border-top: 1px solid #f8f9fa; }
        .collapsed .item-body { display: none; }

        .remove-btn { 
            position: absolute; right: 12px; top: 12px; 
            background: #fff0f0; color: var(--danger); 
            width: 30px; height: 30px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; border: none; z-index: 10;
        }

        .label-text { font-size: 0.85rem; font-weight: 700; margin: 15px 0 8px 2px; display: block; color: var(--text-main); }

        /* ì¹© ë””ìì¸ ê°œì„  */
        .flex-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .chip { 
            font-size: 0.8rem; background: #f1f3f5; border: 1.5px solid transparent; 
            padding: 10px 14px; border-radius: 12px; cursor: pointer; 
            transition: 0.2s; font-weight: 500; color: var(--text-sub);
        }
        .chip input { display: none; }
        .chip:has(input:checked) { 
            background: #eef2ff; border-color: var(--primary); color: var(--primary); font-weight: 700;
        }

        button { width: 100%; padding: 16px; border: none; border-radius: 18px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .add-btn { background: #f1f3f5; color: var(--text-main); margin-bottom: 12px; }
        .calc-btn { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(92, 103, 242, 0.3); }
        .save-btn { background: var(--primary); color: white; margin-top: 20px; }
        .clear-btn { background: transparent; color: var(--text-sub); font-size: 0.8rem; text-decoration: underline; margin-top: 10px; }

        /* ê²°ê³¼ ì°½ */
        .result-box { background: #1a1c1e; color: #fff; padding: 25px; border-radius: 28px; display: none; margin-top: 25px; }
        .highlight { color: var(--accent); font-weight: 800; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>ğŸ§¾ Team Settlement</h2>
        <div id="itemList"></div>
        <button class="add-btn" onclick="addNewItem()">+ ìƒˆë¡œìš´ ì°¨ìˆ˜ ì¶”ê°€</button>
        <button class="calc-btn" onclick="calculate()">ğŸš€ ì •ì‚° ê²°ê³¼ í™•ì¸</button>
        <button class="clear-btn" onclick="clearAllItems()">ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>

    <div id="captureArea">
        <div id="result" class="result-box">
            <h3 style="text-align:center; margin-bottom:20px;">ğŸ“Š ì •ì‚° ë¦¬í¬íŠ¸</h3>
            <div id="reportHeader"></div>
            <div id="reportGuide" style="margin-top:20px;"></div>
            <div id="privateSection"></div>
        </div>
    </div>
    
    <div id="actionButtons" style="display:none;">
        <button style="background:var(--text-main); color:white; margin-top:15px;" onclick="saveAsImage()">ğŸ–¼ï¸ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
</div>

<script>
    // íŒ€ ë°ì´í„° ì •ì˜
    const teams = {
        A: { name: "AíŒ€", members: "ì˜ì„±,ì§€í˜œ" },
        B: { name: "BíŒ€", members: "í˜„ìˆ˜,ë¯¸ì˜" },
        C: { name: "CíŒ€", members: "ì§€í›ˆ,ì€í˜œ" }
    };

    const payers = [
        `${teams.A.name}(${teams.A.members})`,
        `${teams.B.name}(${teams.B.members})`,
        "ì§€í›ˆ", "ì€í˜œ"
    ];

    window.onload = () => {
        const saved = localStorage.getItem('settlementDataV8');
        if (saved) JSON.parse(saved).forEach(data => renderItem(data));
        else addNewItem();
    }

    function renderItem(data = null) {
        const tempId = Date.now() + Math.random();
        const div = document.createElement('div');
        div.className = `item-group ${data?.collapsed ? 'collapsed' : ''}`;
        div.setAttribute('data-id', tempId);
        
        div.innerHTML = `
            <button class="remove-btn" onclick="removeItem(this)">Ã—</button>
            <div class="item-header" onclick="toggleItem(this)">
                <span class="title-text">...</span>
                <div class="sub-text"></div>
            </div>
            <div class="item-body">
                <input type="text" placeholder="í•­ëª©ëª… (ì˜ˆ: 1ì°¨ ì ì‹¬)" class="input-field item-name" value="${data?.name || ''}" oninput="updateHeader(this)">
                <input type="text" placeholder="ê¸ˆì•¡ ì…ë ¥" class="input-field item-amount" inputmode="numeric" value="${data?.amount || ''}" oninput="formatAmount(this); updateHeader(this)">
                
                <span class="label-text">ğŸ’³ ê²°ì œì ì„ íƒ</span>
                <div class="flex-group">
                    ${payers.map(p => `
                        <label class="chip"><input type="radio" name="payer_${tempId}" value="${p}" ${data?.payer === p ? 'checked' : ''} onchange="updateHeader(this)">${p}</label>
                    `).join('')}
                </div>
                
                <span class="label-text">ğŸ‘¥ ì°¸ì—¬ íŒ€ (ì´ë¦„ í¬í•¨)</span>
                <div class="flex-group">
                    ${Object.keys(teams).map(key => `
                        <label class="chip">
                            <input type="checkbox" class="team-${key.toLowerCase()}" ${data?.teams?.[key] !== false ? 'checked' : ''} onchange="updateHeader(this)">
                            ${teams[key].name}(${teams[key].members})
                        </label>
                    `).join('')}
                </div>
                <button class="save-btn" onclick="saveAndCollapse(this)">ì…ë ¥ ì™„ë£Œ ë° ì ‘ê¸°</button>
            </div>
        `;
        document.getElementById('itemList').appendChild(div);
        updateHeader(div.querySelector('.item-name'));
    }

    function updateHeader(el) {
        const g = el.closest('.item-group');
        const name = g.querySelector('.item-name').value || "í•­ëª©ëª… ë¯¸ì…ë ¥";
        const amt = g.querySelector('.item-amount').value || "0";
        const payer = g.querySelector(`input[type="radio"]:checked`)?.value || "ê²°ì œì ë¯¸ì§€ì •";
        
        // ì°¸ì—¬ íŒ€ ìš”ì•½ í…ìŠ¤íŠ¸ ìƒì„±
        const activeTeams = [];
        if(g.querySelector('.team-a').checked) activeTeams.push(`${teams.A.name}(${teams.A.members})`);
        if(g.querySelector('.team-b').checked) activeTeams.push(`${teams.B.name}(${teams.B.members})`);
        if(g.querySelector('.team-c').checked) activeTeams.push(`${teams.C.name}(${teams.C.members})`);
        
        g.querySelector('.title-text').innerText = `${name} (${amt}ì›)`;
        g.querySelector('.sub-text').innerHTML = `<b>ê²°ì œ:</b> ${payer}<br><b>ì°¸ì—¬:</b> ${activeTeams.join(', ') || 'ì—†ìŒ'}`;
        saveToLocal();
    }

    function formatAmount(obj) {
        let v = obj.value.replace(/[^0-9]/g, "");
        obj.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function saveToLocal() {
        const items = Array.from(document.querySelectorAll('.item-group')).map(g => {
            const id = g.getAttribute('data-id');
            return {
                name: g.querySelector('.item-name').value,
                amount: g.querySelector('.item-amount').value,
                payer: g.querySelector(`input[name="payer_${id}"]:checked`)?.value || "",
                teams: { 
                    A: g.querySelector('.team-a').checked, 
                    B: g.querySelector('.team-b').checked, 
                    C: g.querySelector('.team-c').checked 
                },
                collapsed: g.classList.contains('collapsed')
            };
        });
        localStorage.setItem('settlementDataV8', JSON.stringify(items));
    }

    function toggleItem(h) { h.closest('.item-group').classList.toggle('collapsed'); }
    function saveAndCollapse(b) { b.closest('.item-group').classList.add('collapsed'); saveToLocal(); }
    function removeItem(b) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { b.closest('.item-group').remove(); saveToLocal(); } }
    function clearAllItems() { if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.clear(); location.reload(); } }

    function addNewItem() { renderItem(); window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'}); }

    function calculate() {
        saveToLocal();
        const items = JSON.parse(localStorage.getItem('settlementDataV8') || "[]");
        if(items.some(i => !i.payer || !i.amount || i.amount === "0")) return alert("ê²°ì œì ë˜ëŠ” ê¸ˆì•¡ì´ ì…ë ¥ë˜ì§€ ì•Šì€ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.");

        let total = 0, teamPaid = {A:0, B:0, C:0}, teamSpent = {A:0, B:0, C:0}, indC = {ì§€í›ˆ:0, ì€í˜œ:0};
        let tableHtml = `<table style="width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:10px;">
                        <tr style="border-bottom:1px solid #444; color:#888;"><th align="left">í•­ëª©</th><th align="left">ê²°ì œ</th><th align="right">ê¸ˆì•¡</th></tr>`;

        items.forEach((item, idx) => {
            const amt = Number(item.amount.replace(/,/g,''));
            total += amt;
            tableHtml += `<tr style="border-bottom:1px solid #2a2d30;"><td style="padding:10px 0;">${item.name || (idx+1)+'ì°¨'}</td><td>${item.payer.split('(')[0]}</td><td align="right">${amt.toLocaleString()}ì›</td></tr>`;
            
            if(item.payer.includes('AíŒ€')) teamPaid.A += amt;
            else if(item.payer.includes('BíŒ€')) teamPaid.B += amt;
            else { 
                teamPaid.C += amt; 
                if(item.payer === 'ì§€í›ˆ') indC.ì§€í›ˆ += amt; 
                if(item.payer === 'ì€í˜œ') indC.ì€í˜œ += amt; 
            }

            const active = Object.keys(item.teams).filter(k => item.teams[k]);
            active.forEach(t => teamSpent[t] += (amt / active.length));
        });

        let diff = [
            {n: `${teams.A.name}(${teams.A.members})`, v: teamPaid.A-teamSpent.A},
            {n: `${teams.B.name}(${teams.B.members})`, v: teamPaid.B-teamSpent.B},
            {n: `${teams.C.name}(${teams.C.members})`, v: teamPaid.C-teamSpent.C}
        ];

        let msg = "";
        diff.filter(d => d.v < 0).forEach(d => {
            let debt = Math.abs(d.v);
            diff.filter(c => c.v > 0).forEach(c => {
                if(debt <= 0 || c.v <= 0) return;
                let p = Math.min(debt, c.v);
                msg += `<div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; margin-bottom:10px; border:1px solid rgba(255,255,255,0.1);">
                            <span style="color:var(--accent); font-weight:700; display:block; margin-bottom:5px;">ğŸ’° ${d.n} â†’ ${c.n}</span>
                            <span style="font-size:0.9rem;">ë³´ë‚¼ ê¸ˆì•¡: <b class="highlight">${Math.round(p).toLocaleString()}ì›</b></span>
                        </div>`;
                debt -= p; c.v -= p;
            });
        });

        document.getElementById('reportHeader').innerHTML = tableHtml + `<div style="text-align:right; font-weight:bold; margin-top:15px; color:var(--accent); font-size:1.1rem;">ì´ ì§€ì¶œì•¡: ${total.toLocaleString()}ì›</div>`;
        document.getElementById('reportGuide').innerHTML = `<div style="color:#888; font-size:0.8rem; margin-bottom:10px;">FINAL GUIDE</div>${msg || "ì •ì‚° ë‚´ì—­ì´ ì™„ë²½í•©ë‹ˆë‹¤!"}`;
        
        const toSendC = (teamSpent.C/2) - indC.ì€í˜œ;
        document.getElementById('privateSection').innerHTML = `<div style="margin-top:20px; padding-top:15px; border-top:1px dashed #444; font-size:0.8rem; color:#aaa;">[CíŒ€ ë‚´ë¶€ ì •ì‚°] ${toSendC > 0 ? 'ì€í˜œ â†’ ì§€í›ˆ' : 'ì§€í›ˆ â†’ ì€í˜œ'}: <span class="highlight">${Math.round(Math.abs(toSendC)).toLocaleString()}ì›</span></div>`;
        
        document.getElementById('result').style.display = 'block';
        document.getElementById('actionButtons').style.display = 'block';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function saveAsImage() {
        const ps = document.getElementById('privateSection');
        ps.style.display = 'none';
        html2canvas(document.getElementById('captureArea'), { backgroundColor: "#f8f9fd", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Settlement_Report.png`;
            link.href = canvas.toDataURL();
            link.click();
            ps.style.display = 'block';
        });
    }
</script>
</body>
</html>
