<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì»¤ìŠ¤í…€ íŒ€ ì •ì‚° ì–´í”Œ</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f2f4f7; --card-bg: #ffffff; --danger: #ff4d4f; --success: #28a745; --dark: #2d3436; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; margin: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 450px; margin: 0 auto; padding-bottom: 30px; }
        .card { background: var(--card-bg); padding: 15px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 12px; }
        h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 1px solid #f1f3f5; padding-bottom: 10px; text-align: center; }
        
        /* ì„¤ì • ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .settings-content { display: none; padding-top: 10px; }
        .settings-content.active { display: block; }
        .setting-row { margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .setting-row input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85rem; margin-top: 5px; }

        .item-group { border: 1px solid #eee; border-radius: 12px; margin-bottom: 10px; overflow: hidden; background: #fff; position: relative; }
        .item-header { padding: 10px 45px 10px 12px; cursor: pointer; display: flex; flex-direction: column; gap: 2px; }
        .item-body { padding: 15px; border-top: 1px solid #eee; background: #fdfdfd; }
        .collapsed .item-body { display: none; }
        
        .remove-btn { position: absolute; right: 8px; top: 8px; background: #f1f3f5; color: #adb5bd; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; border: none; z-index: 5; }
        input[type="text"] { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 0.9rem; }
        .label-text { font-size: 0.75rem; font-weight: bold; margin-top: 8px; display: block; color: #777; }
        .flex-group { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
        .radio-item, .check-item { font-size: 0.75rem; background: #fff; border: 1px solid #e2e8f0; padding: 5px 8px; border-radius: 15px; cursor: pointer; display: flex; align-items: center; gap: 3px; }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .save-btn { background: var(--success); color: white; margin-top: 10px; padding: 10px; font-size: 0.85rem; }
        .add-btn { background: #495057; color: white; margin-bottom: 8px; }
        .clear-btn { background: #f1f3f5; color: #adb5bd; margin-bottom: 8px; padding: 10px; font-size: 0.8rem; }
        .calc-btn { background: var(--primary); color: white; }
        .image-btn { background: #6c5ce7; color: white; margin-top: 15px; }

        .result-box { background: var(--dark); color: #fff; padding: 20px; border-radius: 18px; display: none; margin-top: 15px; }
        .report-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.75rem; color: #ddd; }
        .report-table th { border-bottom: 1px solid #555; padding: 5px; text-align: left; }
        .report-table td { padding: 5px; border-bottom: 1px solid #444; }
        .highlight { color: #f39c12; font-weight: bold; }
        
        .guide-container { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #444; }
        .guide-container:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .guide-team { font-size: 0.85rem; margin-bottom: 4px; display: block; color: #f39c12; font-weight: bold; }
        .guide-detail { font-size: 0.8rem; color: #fff; display: flex; justify-content: flex-start; align-items: center; gap: 5px; }
        .send-label { font-size: 0.7rem; color: #aaa; background: #444; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card" style="border: 2px solid var(--primary);">
        <h2 onclick="toggleSettings()" style="cursor:pointer; border-bottom:none; margin-bottom:0;">âš™ï¸ íŒ€ ë° ë©¤ë²„ ì„¤ì • (í´ë¦­)</h2>
        <div id="settingsContent" class="settings-content">
            <div id="teamSettingsArea"></div>
            <p style="font-size:0.7rem; color:#888;">* ìˆ˜ì • í›„ 'ê²°ì œ ë‚´ì—­'ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ§¾ ì •ì‚° í•­ëª© ì…ë ¥</h2>
        <div id="itemList"></div>
        <button class="add-btn" onclick="addNewItem()">+ ìƒˆë¡œìš´ ì°¨ìˆ˜ ì¶”ê°€</button>
        <button class="clear-btn" onclick="clearAllItems()">ğŸ—‘ï¸ ëª¨ë“  ë‚´ì—­ ì§€ìš°ê¸°</button>
        <button class="calc-btn" onclick="calculate()">ğŸš€ ì •ì‚° ê²°ê³¼ í™•ì¸</button>
    </div>

    <div id="captureArea">
        <div id="result" class="result-box card">
            <h3 style="color:white; margin-top:0; text-align:center; font-size:1.1rem;">ğŸ“Š ìµœì¢… ì •ì‚° ë¦¬í¬íŠ¸</h3>
            <div id="reportHeader"></div>
            <div id="reportGuide"></div>
            <div id="privateSection"></div>
        </div>
    </div>
    
    <div id="actionButtons" style="display:none;">
        <button class="image-btn" onclick="saveAsImage()">ğŸ–¼ï¸ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<script>
    // ê¸°ë³¸ ì„¤ì •ê°’
    let config = {
        teams: [
            { id: 'A', name: 'AíŒ€', members: ['ì˜ì„±', 'ì§€í˜œ'] },
            { id: 'B', name: 'BíŒ€', members: ['í˜„ìˆ˜', 'ë¯¸ì˜'] },
            { id: 'C', name: 'CíŒ€', members: ['ì§€í›ˆ', 'ì€í˜œ'] }
        ]
    };

    window.onload = function() {
        const savedConfig = localStorage.getItem('teamConfig');
        if (savedConfig) config = JSON.parse(savedConfig);
        
        renderSettings();

        const savedData = localStorage.getItem('settlementData');
        if (savedData) {
            JSON.parse(savedData).forEach((item) => renderItem(item));
        } else {
            addNewItem();
        }
    }

    function toggleSettings() {
        document.getElementById('settingsContent').classList.toggle('active');
    }

    // ì„¤ì • í™”ë©´ ë Œë”ë§
    function renderSettings() {
        const area = document.getElementById('teamSettingsArea');
        area.innerHTML = config.teams.map((t, idx) => `
            <div class="setting-row">
                <span class="label-text">${idx+1}ë²ˆ íŒ€ ì •ë³´</span>
                <input type="text" value="${t.name}" oninput="updateConfig(${idx}, 'name', this.value)" placeholder="íŒ€ëª… (ì˜ˆ: AíŒ€)">
                <input type="text" value="${t.members.join(', ')}" oninput="updateConfig(${idx}, 'members', this.value)" placeholder="ë©¤ë²„ëª… (ì‰¼í‘œë¡œ êµ¬ë¶„)">
            </div>
        `).join('');
    }

    function updateConfig(idx, key, value) {
        if (key === 'members') {
            config.teams[idx].members = value.split(',').map(m => m.trim()).filter(m => m !== "");
        } else {
            config.teams[idx].name = value;
        }
        localStorage.setItem('teamConfig', JSON.stringify(config));
        refreshAllItems(); // ê¸°ì¡´ ì…ë ¥ì°½ì˜ ì„ íƒì§€ë“¤ì„ ì—…ë°ì´íŠ¸
    }

    function refreshAllItems() {
        const currentItems = grabCurrentItemsData();
        document.getElementById('itemList').innerHTML = "";
        currentItems.forEach(item => renderItem(item));
    }

    function grabCurrentItemsData() {
        const items = [];
        document.querySelectorAll('.item-group').forEach(g => {
            const tempId = g.getAttribute('data-id');
            items.push({
                name: g.querySelector('.item-name').value,
                amount: g.querySelector('.item-amount').value,
                payer: g.querySelector(`input[name="payer_${tempId}"]:checked`)?.value || "",
                teams: { 
                    A: g.querySelector('.team-a')?.checked ?? true, 
                    B: g.querySelector('.team-b')?.checked ?? true, 
                    C: g.querySelector('.team-c')?.checked ?? true 
                },
                collapsed: g.classList.contains('collapsed')
            });
        });
        return items;
    }

    function renderItem(data = null) {
        const tempId = Date.now() + Math.random();
        const div = document.createElement('div');
        div.className = `item-group ${data?.collapsed ? 'collapsed' : ''}`;
        div.setAttribute('data-id', tempId);
        
        // ê²°ì œì í›„ë³´êµ° ìƒì„± (íŒ€ëª… + ê°œë³„ ë©¤ë²„)
        const payers = [];
        config.teams.forEach(t => {
            payers.push(`${t.name}(${t.members.join(',')})`);
            t.members.forEach(m => payers.push(m));
        });
        const uniquePayers = [...new Set(payers)];

        div.innerHTML = `
            <button class="remove-btn" onclick="removeItem(this)">Ã—</button>
            <div class="item-header" onclick="toggleItem(this)">
                <span style="font-weight:bold; font-size:0.9rem;" class="title-text">...</span>
                <div style="font-size:0.65rem; color:#888;" class="sub-text"></div>
            </div>
            <div class="item-body">
                <input type="text" placeholder="í•­ëª©ëª… (ì˜ˆ: ê°ìíƒ•)" class="item-name" value="${data?.name || ''}" oninput="updateHeader(this)">
                <input type="text" placeholder="ê²°ì œ ê¸ˆì•¡" class="item-amount" inputmode="numeric" value="${data?.amount || ''}" oninput="formatAmount(this); updateHeader(this)">
                <span class="label-text">ğŸ’³ ëˆ„ê°€ ê²°ì œí–ˆë‚˜ìš”?</span>
                <div class="flex-group">
                    ${uniquePayers.map(p => `
                        <label class="radio-item"><input type="radio" name="payer_${tempId}" value="${p}" ${data?.payer === p ? 'checked' : ''} onchange="updateHeader(this)">${p}</label>
                    `).join('')}
                </div>
                <span class="label-text">ğŸ‘¥ ì°¸ì—¬í•œ íŒ€ ì„ íƒ</span>
                <div class="flex-group">
                    ${config.teams.map(t => `
                        <label class="check-item"><input type="checkbox" class="team-${t.id.toLowerCase()}" ${data?.teams?.[t.id] !== false ? 'checked' : ''} onchange="updateHeader(this)">${t.name}</label>
                    `).join('')}
                </div>
                <button class="save-btn" onclick="saveAndCollapse(this)">âœ” ì´ ë‚´ì—­ ì €ì¥ ë° ì ‘ê¸°</button>
            </div>
        `;
        document.getElementById('itemList').appendChild(div);
        updateHeader(div.querySelector('.item-name'));
    }

    function updateHeader(element) {
        const g = element.closest('.item-group');
        const nameInput = g.querySelector('.item-name').value;
        const amt = g.querySelector('.item-amount').value || "0";
        const payer = g.querySelector(`input[type="radio"]:checked`)?.value || "ë¯¸ì„ íƒ";
        
        const activeTeams = [];
        config.teams.forEach(t => {
            if(g.querySelector(`.team-${t.id.toLowerCase()}`).checked) activeTeams.push(t.name);
        });

        const allGroups = Array.from(document.querySelectorAll('.item-group'));
        const index = allGroups.indexOf(g) + 1;
        g.querySelector('.title-text').innerText = `${nameInput || index + "ì°¨"} (${amt}ì›)`;
        g.querySelector('.sub-text').innerHTML = `ê²°ì œ: ${payer.split('(')[0]} | ì°¸ì—¬: ${activeTeams.join(', ')}`;
        saveToLocal();
    }

    function formatAmount(obj) {
        let value = obj.value.replace(/[^0-9]/g, "");
        obj.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function addNewItem() { renderItem(); }

    function clearAllItems() {
        if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem('settlementData');
            document.getElementById('itemList').innerHTML = "";
            document.getElementById('result').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            addNewItem();
        }
    }

    function saveAndCollapse(btn) {
        btn.closest('.item-group').classList.add('collapsed');
        saveToLocal();
    }

    function saveToLocal() {
        localStorage.setItem('settlementData', JSON.stringify(grabCurrentItemsData()));
    }

    function toggleItem(header) { header.closest('.item-group').classList.toggle('collapsed'); }
    function removeItem(btn) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { btn.closest('.item-group').remove(); saveToLocal(); } }

    function calculate() {
        saveToLocal();
        const items = JSON.parse(localStorage.getItem('settlementData') || "[]");
        if (items.find(i => !i.payer || !i.amount || i.amount === "0")) return alert("ê²°ì œ ì •ë³´ê°€ ë¶€ì¡±í•œ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.");

        let total = 0;
        let teamPaid = { A: 0, B: 0, C: 0 };
        let teamSpent = { A: 0, B: 0, C: 0 };
        // ë‚´ë¶€ ì •ì‚°ì„ ìœ„í•œ ë°ì´í„° êµ¬ì¡° (ë©¤ë²„ë³„ ì§€ì¶œ/ê²°ì œì•¡)
        let memberFlow = {}; 
        config.teams.forEach(t => t.members.forEach(m => memberFlow[m] = { paid: 0, spent: 0, teamId: t.id }));

        let tableHtml = `<table class="report-table"><tr><th>í•­ëª©</th><th>ê²°ì œì</th><th>ê¸ˆì•¡</th></tr>`;

        items.forEach((item, idx) => {
            const amt = Number(item.amount.replace(/,/g,''));
            total += amt;
            tableHtml += `<tr><td>${item.name || (idx+1)+'ì°¨'}</td><td>${item.payer.split('(')[0]}</td><td>${amt.toLocaleString()}ì›</td></tr>`;
            
            // 1. ëˆ„ê°€ ê²°ì œí–ˆëŠ”ì§€ íŒë³„
            config.teams.forEach(t => {
                if(item.payer.startsWith(t.name)) teamPaid[t.id] += amt;
            });
            // ë©¤ë²„ ê°œì¸ì´ ê²°ì œí•œ ê²½ìš°
            if(memberFlow[item.payer]) {
                teamPaid[memberFlow[item.payer].teamId] += amt;
                memberFlow[item.payer].paid += amt;
            }

            // 2. ì–´ë–¤ íŒ€ì´ ì°¸ì—¬í–ˆëŠ”ì§€ íŒë³„ ë° ì§€ì¶œì•¡ ë¶„ë°°
            const activeTeamIds = Object.keys(item.teams).filter(k => item.teams[k]);
            const perTeamAmt = amt / activeTeamIds.length;
            
            activeTeamIds.forEach(tid => {
                teamSpent[tid] += perTeamAmt;
                // ë‚´ë¶€ ì •ì‚°ì„ ìœ„í•´ ë©¤ë²„ë³„ë¡œ ìª¼ê°œê¸°
                const team = config.teams.find(t => t.id === tid);
                const perMemberAmt = perTeamAmt / team.members.length;
                team.members.forEach(m => memberFlow[m].spent += perMemberAmt);
            });
        });

        // 3. íŒ€ ê°„ ì†¡ê¸ˆ ê³„ì‚°
        let diff = config.teams.map(t => ({ id: t.id, name: `${t.name}(${t.members.join(',')})`, v: teamPaid[t.id] - teamSpent[t.id] }));
        let msg = "";
        diff.filter(d => d.v < 0).forEach(d => {
            let debt = Math.abs(d.v);
            diff.filter(c => c.v > 0).forEach(c => {
                if(debt <= 0 || c.v <= 0) return;
                let p = Math.min(debt, c.v);
                msg += `<div class="guide-container">
                            <span class="guide-team">ğŸ’° ${d.name} â†’ ${c.name}</span>
                            <div class="guide-detail"><span class="send-label">ë³´ë‚´ì•¼ í•  ëˆ</span><span class="highlight">${Math.round(p).toLocaleString()}ì›</span></div>
                        </div>`;
                debt -= p; c.v -= p;
            });
        });

        // 4. íŒ€ ë‚´ ë©¤ë²„ê°„ ë‚´ë¶€ ì •ì‚° ê³„ì‚° (ëª¨ë“  íŒ€ ëŒ€ìƒ)
        let internalMsg = "";
        config.teams.forEach(t => {
            const members = t.members;
            if(members.length < 2) return;
            
            let mDiff = members.map(m => ({ name: m, v: memberFlow[m].paid - memberFlow[m].spent }));
            // íŒ€ ë‚´ì—ì„œ ì •ì‚°ì´ í•„ìš”í•œ ê²½ìš°ë§Œ í‘œì‹œ
            mDiff.filter(d => d.v < 0).forEach(d => {
                let dAmt = Math.abs(d.v);
                mDiff.filter(c => c.v > 0).forEach(c => {
                    if(dAmt <= 0 || c.v <= 0) return;
                    let p = Math.min(dAmt, c.v);
                    internalMsg += `<div style="font-size:0.75rem; color:#ccc;">[${t.name} ë‚´ë¶€] ${d.name} â†’ ${c.name}: <span class="highlight">${Math.round(p).toLocaleString()}ì›</span></div>`;
                    dAmt -= p; c.v -= p;
                });
            });
        });

        document.getElementById('reportHeader').innerHTML = `<div style="font-size:0.8rem; color:#bbb; border-bottom:1px solid #555; padding-bottom:5px;">ğŸ“ ì§€ì¶œ ë‚´ì—­</div>${tableHtml}<div style="text-align:right; font-weight:bold; margin:10px 0; color:#f39c12;">ì´ì•¡: ${total.toLocaleString()}ì›</div>`;
        document.getElementById('reportGuide').innerHTML = `<div style="font-size:0.8rem; color:#bbb; margin-bottom:8px;">ğŸ“ ìµœì¢… ì†¡ê¸ˆ ê°€ì´ë“œ</div><div style="background:#3d4446; padding:15px; border-radius:12px;">${msg || "ì •ì‚° ì™„ë£Œ"}</div>`;
        document.getElementById('privateSection').innerHTML = `<hr style="border:0; border-top:1px dashed #555; margin:15px 0;">${internalMsg || '<div style="font-size:0.75rem; color:#888;">ë‚´ë¶€ ì •ì‚° ë‚´ì—­ ì—†ìŒ</div>'}`;
        
        document.getElementById('result').style.display = 'block';
        document.getElementById('actionButtons').style.display = 'block';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function saveAsImage() {
        const priv = document.getElementById('privateSection');
        priv.style.display = 'none';
        html2canvas(document.getElementById('captureArea'), { backgroundColor: "#f2f4f7", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `ì •ì‚°ë¦¬í¬íŠ¸_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL();
            link.click();
            priv.style.display = 'block';
        });
    }
</script>
</body>
</html>
