<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>íŒ€ ì •ì‚° ë§¤ë‹ˆì €</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f2f4f7; --card-bg: #ffffff; --danger: #ff4d4f; --success: #28a745; --dark: #2d3436; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; margin: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 450px; margin: 0 auto; padding-bottom: 50px; }
        .card { background: var(--card-bg); padding: 15px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h2 { margin-top: 0; font-size: 1.2rem; border-bottom: 2px solid var(--primary); padding-bottom: 10px; text-align: center; color: var(--primary); }
        .item-group { border: 1px solid #eef0f2; border-radius: 12px; margin-bottom: 12px; overflow: hidden; background: #fff; position: relative; }
        .item-group.collapsed { border-left: 4px solid var(--primary); }
        .item-header { padding: 12px 45px 12px 15px; cursor: pointer; display: flex; flex-direction: column; gap: 4px; background: #fafbfc; }
        .item-body { padding: 15px; border-top: 1px solid #eee; background: #fff; }
        .collapsed .item-body { display: none; }
        .remove-btn { position: absolute; right: 8px; top: 12px; background: #ffeded; color: var(--danger); width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: none; z-index: 5; }
        input[type="text"] { width: 100%; padding: 12px; margin: 8px 0; border: 1.5px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 1rem; }
        .label-text { font-size: 0.8rem; font-weight: 700; margin-top: 12px; display: block; color: #555; }
        .flex-group { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
        .radio-item, .check-item { font-size: 0.75rem; background: #f8f9fa; border: 1px solid #e2e8f0; padding: 6px 10px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        button { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: opacity 0.2s; }
        .save-btn { background: var(--success); color: white; margin-top: 15px; font-size: 0.9rem; }
        .add-btn { background: var(--dark); color: white; margin-bottom: 10px; }
        .clear-btn { background: #e9ecef; color: #868e96; margin-bottom: 10px; padding: 10px; font-size: 0.8rem; }
        .calc-btn { background: var(--primary); color: white; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3); }
        .image-btn { background: #6c5ce7; color: white; margin-top: 15px; }
        .result-box { background: var(--dark); color: #fff; padding: 20px; border-radius: 18px; display: none; margin-top: 20px; }
        .report-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.8rem; color: #eee; }
        .report-table th { border-bottom: 1px solid #555; padding: 8px; text-align: left; color: #aaa; }
        .report-table td { padding: 8px; border-bottom: 1px solid #444; }
        .highlight { color: #f39c12; font-weight: bold; font-size: 1rem; }
        .guide-container { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #4d5456; }
        .guide-team { font-size: 0.9rem; margin-bottom: 6px; display: block; color: #f39c12; font-weight: bold; }
        .send-label { font-size: 0.7rem; color: #ccc; background: #444; padding: 3px 8px; border-radius: 5px; margin-right: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>ğŸ§¾ íŒ€ ì •ì‚° ë§¤ë‹ˆì €</h2>
        <div id="itemList"></div>
        <button class="add-btn" onclick="addNewItem()">+ ìƒˆë¡œìš´ ì°¨ìˆ˜ ì¶”ê°€</button>
        <button class="clear-btn" onclick="clearAllItems()">ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”</button>
        <button class="calc-btn" onclick="calculate()">ğŸš€ ì •ì‚° ê²°ê³¼ ê³„ì‚°í•˜ê¸°</button>
    </div>

    <div id="captureArea">
        <div id="result" class="result-box card">
            <h3 style="color:white; margin-top:0; text-align:center; font-size:1.2rem;">ğŸ“Š ìµœì¢… ì •ì‚° ë¦¬í¬íŠ¸</h3>
            <div id="reportHeader"></div>
            <div id="reportGuide"></div>
            <div id="privateSection" data-html2canvas-ignore="true"></div>
        </div>
    </div>
    
    <div id="actionButtons" style="display:none;">
        <button class="image-btn" id="saveBtn" onclick="saveAsImage()">ğŸ–¼ï¸ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
</div>

<script>
    const teamNames = { A: "AíŒ€(ì˜ì„±,ì§€í˜œ)", B: "BíŒ€(í˜„ìˆ˜,ë¯¸ì˜)", C: "CíŒ€(ì§€í›ˆ,ì€í˜œ)" };

    window.onload = function() {
        const savedData = localStorage.getItem('settlementData');
        if (savedData) { JSON.parse(savedData).forEach((item) => renderItem(item)); } 
        else { addNewItem(); }
    }

    function renderItem(data = null) {
        const tempId = Date.now() + Math.random();
        const div = document.createElement('div');
        div.className = `item-group ${data?.collapsed ? 'collapsed' : ''}`;
        div.setAttribute('data-id', tempId);
        div.innerHTML = `
            <button class="remove-btn" onclick="removeItem(this)">Ã—</button>
            <div class="item-header" onclick="toggleItem(this)">
                <span class="title-text" style="font-weight:bold; color:var(--dark);">...</span>
                <div class="sub-text" style="font-size:0.7rem; color:#888;"></div>
            </div>
            <div class="item-body">
                <input type="text" placeholder="í•­ëª©ëª…" class="item-name" value="${data?.name || ''}" oninput="updateHeader(this)">
                <input type="text" placeholder="ê²°ì œ ê¸ˆì•¡" class="item-amount" inputmode="numeric" value="${data?.amount || ''}" oninput="formatAmount(this); updateHeader(this)">
                <span class="label-text">ğŸ’³ ê²°ì œì</span>
                <div class="flex-group">
                    ${[teamNames.A, teamNames.B, 'ì§€í›ˆ', 'ì€í˜œ'].map(p => `
                        <label class="radio-item"><input type="radio" name="payer_${tempId}" value="${p}" ${data?.payer === p ? 'checked' : ''} onchange="updateHeader(this)">${p}</label>
                    `).join('')}
                </div>
                <span class="label-text">ğŸ‘¥ ì°¸ì—¬ íŒ€</span>
                <div class="flex-group">
                    <label class="check-item"><input type="checkbox" class="team-a" ${data?.teams?.A !== false ? 'checked' : ''} onchange="updateHeader(this)">AíŒ€</label>
                    <label class="check-item"><input type="checkbox" class="team-b" ${data?.teams?.B !== false ? 'checked' : ''} onchange="updateHeader(this)">BíŒ€</label>
                    <label class="check-item"><input type="checkbox" class="team-c" ${data?.teams?.C !== false ? 'checked' : ''} onchange="updateHeader(this)">CíŒ€</label>
                </div>
                <button class="save-btn" onclick="saveAndCollapse(this)">âœ” ì…ë ¥ ì™„ë£Œ</button>
            </div>
        `;
        document.getElementById('itemList').appendChild(div);
        updateHeader(div.querySelector('.item-name'));
    }

    function updateHeader(element) {
        const g = element.closest('.item-group');
        const name = g.querySelector('.item-name').value || "í•­ëª©ë¯¸ì…ë ¥";
        const amt = g.querySelector('.item-amount').value || "0";
        const payer = g.querySelector(`input[type="radio"]:checked`)?.value || "ë¯¸ì„ íƒ";
        g.querySelector('.title-text').innerText = `${name} [${amt}ì›]`;
        g.querySelector('.sub-text').innerText = `ê²°ì œ: ${payer}`;
        saveToLocal();
    }

    function formatAmount(obj) {
        let value = obj.value.replace(/[^0-9]/g, "");
        obj.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function addNewItem() { renderItem(); }
    function clearAllItems() { if(confirm("ì´ˆê¸°í™”í• ê¹Œìš”?")) { localStorage.removeItem('settlementData'); location.reload(); } }
    function saveAndCollapse(btn) { btn.closest('.item-group').classList.add('collapsed'); saveToLocal(); }
    function saveToLocal() {
        const items = [];
        document.querySelectorAll('.item-group').forEach(g => {
            const tempId = g.getAttribute('data-id');
            items.push({
                name: g.querySelector('.item-name').value,
                amount: g.querySelector('.item-amount').value,
                payer: g.querySelector(`input[name="payer_${tempId}"]:checked`)?.value || "",
                teams: { A: g.querySelector('.team-a').checked, B: g.querySelector('.team-b').checked, C: g.querySelector('.team-c').checked },
                collapsed: g.classList.contains('collapsed')
            });
        });
        localStorage.setItem('settlementData', JSON.stringify(items));
    }
    function toggleItem(header) { header.closest('.item-group').classList.toggle('collapsed'); }
    function removeItem(btn) { if(confirm("ì‚­ì œí• ê¹Œìš”?")) { btn.closest('.item-group').remove(); saveToLocal(); } }

    function calculate() {
        saveToLocal();
        const items = JSON.parse(localStorage.getItem('settlementData') || "[]");
        let total = 0, teamPaid = { A: 0, B: 0, C: 0 }, teamSpent = { A: 0, B: 0, C: 0 }, indC = { ì§€í›ˆ: 0, ì€í˜œ: 0 };
        let tableHtml = `<table class="report-table"><tr><th>í•­ëª©</th><th>ê²°ì œì</th><th>ê¸ˆì•¡</th></tr>`;

        items.forEach((item, idx) => {
            const amt = Number(item.amount.replace(/,/g,''));
            if(amt <= 0) return;
            total += amt;
            tableHtml += `<tr><td>${item.name || (idx+1)+'ì°¨'}</td><td>${item.payer}</td><td>${amt.toLocaleString()}ì›</td></tr>`;
            
            if(item.payer === teamNames.A) teamPaid.A += amt;
            else if(item.payer === teamNames.B) teamPaid.B += amt;
            else if(item.payer === 'ì§€í›ˆ') { teamPaid.C += amt; indC.ì§€í›ˆ += amt; }
            else if(item.payer === 'ì€í˜œ') { teamPaid.C += amt; indC.ì€í˜œ += amt; }

            const activeTeams = Object.keys(item.teams).filter(k => item.teams[k]);
            const splitAmt = amt / activeTeams.length;
            activeTeams.forEach(t => teamSpent[t.toUpperCase()] += splitAmt);
        });

        // íŒ€ ê°„ ì •ì‚°
        let diff = [
            {n: teamNames.A, v: teamPaid.A - teamSpent.A},
            {n: teamNames.B, v: teamPaid.B - teamSpent.B},
            {n: teamNames.C, v: teamPaid.C - teamSpent.C}
        ];
        
        let msg = "";
        let creditors = diff.filter(d => d.v > 0).sort((a, b) => b.v - a.v);
        let debtors = diff.filter(d => d.v < 0).sort((a, b) => a.v - b.v);

        debtors.forEach(d => {
            let d_val = Math.abs(d.v);
            creditors.forEach(c => {
                if(d_val <= 0 || c.v <= 0) return;
                let transfer = Math.min(d_val, c.v);
                msg += `<div class="guide-container"><span class="guide-team">ğŸ’° ${d.n} â” ${c.n}</span><br><span class="send-label">ë³´ë‚¼ ê¸ˆì•¡</span><span class="highlight">${Math.round(transfer).toLocaleString()}ì›</span></div>`;
                d_val -= transfer; c.v -= transfer;
            });
        });

        document.getElementById('reportHeader').innerHTML = tableHtml + `</table><div style="text-align:right; font-weight:bold; color:#f39c12;">ì´ì•¡: ${total.toLocaleString()}ì›</div>`;
        document.getElementById('reportGuide').innerHTML = `<div style="font-size:0.8rem; color:#bbb; margin-bottom:8px;">ğŸ“ ìµœì¢… ì†¡ê¸ˆ ê°€ì´ë“œ</div><div style="background:#3d4446; padding:15px; border-radius:12px;">${msg || "ì •ì‚°í•  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤."}</div>`;
        
        // [ìˆ˜ì •ëœ í•µì‹¬ ë¡œì§] CíŒ€ ë‚´ë¶€ ì •ì‚°: (CíŒ€ ë¶„ë‹´ ì´ì•¡ / 2) - ê°œì¸ ì§€ì¶œì•¡
        const perPersonC = teamSpent.C / 2;
        const toSendJihoon = perPersonC - indC.ì§€í›ˆ; // ì–‘ìˆ˜ë©´ ì§€í›ˆì´ê°€ ì€í˜œì—ê²Œ ì¤˜ì•¼ í•¨

        document.getElementById('privateSection').innerHTML = `
            <hr style="border:0; border-top:1px dashed #555; margin:15px 0;">
            <div style="font-size:0.75rem; color:#aaa; margin-bottom:5px;">[CíŒ€ ë‚´ë¶€ ì •ì‚° ì°¸ì¡°]</div>
            <div style="font-size:0.85rem; color:#eee;">
                ${Math.round(toSendJihoon) === 0 ? 'ì§€í›ˆ/ì€í˜œ ì •ì‚° ì™„ë£Œ' : 
                  toSendJihoon > 0 ? `ì§€í›ˆ â” ì€í˜œ: <span class="highlight">${Math.round(Math.abs(toSendJihoon)).toLocaleString()}ì›</span>` : 
                  `ì€í˜œ â” ì§€í›ˆ: <span class="highlight">${Math.round(Math.abs(toSendJihoon)).toLocaleString()}ì›</span>`}
            </div>`;
        
        document.getElementById('result').style.display = 'block';
        document.getElementById('actionButtons').style.display = 'block';
    }

    async function saveAsImage() {
        const captureArea = document.getElementById('captureArea');
        const btn = document.getElementById('saveBtn');
        btn.innerText = "â³ ì´ë¯¸ì§€ ìƒì„± ì¤‘...";
        try {
            const canvas = await html2canvas(captureArea, { backgroundColor: "#2d3436", scale: 3, useCORS: true, ignoreElements: (el) => el.getAttribute('data-html2canvas-ignore') === 'true' });
            const imageData = canvas.toDataURL("image/jpeg", 0.9);
            const link = document.createElement('a');
            link.href = imageData;
            link.download = `ì •ì‚°_${new Date().getTime()}.jpg`;
            link.click();
        } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
        finally { btn.innerText = "ğŸ–¼ï¸ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ ì €ì¥"; }
    }
</script>
</body>
</html>
