<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íŒ€ ì •ì‚° ì–´í”Œ (Pro)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* [Update: 2026-02-03-v20] Header Overlap Fix */
        :root { --primary: #4a90e2; --bg: #f2f4f7; --card-bg: #ffffff; --danger: #ff4d4f; --success: #28a745; --dark: #2d3436; --gray-border: #dfe6e9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; margin: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 450px; margin: 0 auto; padding-bottom: 30px; }
        
        /* [ìˆ˜ì •] í—¤ë” ë ˆì´ì•„ì›ƒ - ê²¹ì¹¨ ì™„ë²½ ë°©ì§€ */
        .app-header { 
            display: flex; 
            justify-content: space-between; /* ì–‘ ë ë°°ë¶„ */
            align-items: center; 
            margin-bottom: 15px; 
            padding: 10px 5px;
            position: relative;
        }
        
        /* [ìˆ˜ì •] ì œëª© ìŠ¤íƒ€ì¼ */
        .app-title { 
            font-size: 1.25rem; 
            color: #333; 
            font-weight: 800; 
            margin: 0;
            /* ì œëª©ì´ ì ˆëŒ€ ì¤‘ì•™ì— ì˜¤ë„ë¡ í•˜ê¸° ìœ„í•œ íŠ¸ë¦­: ì¢Œìš° ì—¬ë°± ìë™ */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            z-index: 1; /* ë²„íŠ¼ë³´ë‹¤ ì•„ë˜ì— ê¹”ë¦¬ë”ë¼ë„ ê¸€ìëŠ” ë³´ì´ê²Œ */
        }

        /* [ìˆ˜ì •] ì„¤ì • ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .setting-btn { 
            /* ì ˆëŒ€ ìœ„ì¹˜ ëŒ€ì‹  Flex ì•„ì´í…œìœ¼ë¡œ ë°°ì¹˜í•˜ë˜, ìš°ì¸¡ ëìœ¼ë¡œ ë°€ì–´ë²„ë¦¼ */
            margin-left: auto; /* ì™¼ìª½ ì—¬ë°±ì„ ë‹¤ ì°¨ì§€í•´ì„œ ìš°ì¸¡ìœ¼ë¡œ ë°€ë¦¼ */
            background: transparent; 
            border: none; 
            padding: 8px; 
            font-size: 1.4rem; 
            cursor: pointer; 
            color: #888; 
            transition: color 0.2s;
            z-index: 10; /* ì œëª©ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
            display: block; /* ëª…ì‹œì  ë¸”ë¡ */
        }
        .setting-btn:active { color: #333; transform: scale(0.9); }

        .card { background: var(--card-bg); padding: 15px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 12px; }
        
        /* ì•„ì´í…œ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .item-group { border: 1px solid #eee; border-radius: 12px; margin-bottom: 10px; overflow: hidden; background: #fff; position: relative; transition: all 0.3s ease; }
        .item-group.collapsed { border-left: 6px solid var(--success); background: #fafbfc; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .item-group.collapsed .title-text::before { content: "âœ”"; color: var(--success); margin-right: 6px; font-weight: bold; }
        
        .item-header { padding: 12px 45px 12px 15px; cursor: pointer; display: flex; flex-direction: column; gap: 4px; }
        
        .sub-text { font-size: 0.75rem; color: #666; line-height: 1.4; }
        .info-row { display: flex; align-items: flex-start; gap: 4px; margin-bottom: 2px; }
        .info-label { font-weight: bold; color: #888; white-space: nowrap; }
        .info-val { color: #333; font-weight: 500; word-break: break-all; }
        .info-val.team-list { color: var(--primary); }

        .item-body { padding: 15px; border-top: 1px solid #eee; background: #fdfdfd; }
        .collapsed .item-body { display: none; }
        .remove-btn { position: absolute; right: 8px; top: 10px; background: #f1f3f5; color: #adb5bd; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; border: none; z-index: 5; }
        
        input[type="text"] { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 0.95rem; }
        .label-text { font-size: 0.8rem; font-weight: bold; margin-top: 12px; margin-bottom: 6px; display: block; color: #555; }
        .flex-group { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }

        .radio-item, .check-item { flex: 1; min-width: 70px; font-size: 0.8rem; background: #fff; border: 1px solid var(--gray-border); padding: 12px 5px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center; transition: all 0.2s; color: #888; font-weight: 500; }
        .radio-item input, .check-item input { display: none; }
        .radio-item:has(input:checked), .check-item:has(input:checked) { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold; box-shadow: 0 4px 8px rgba(74, 144, 226, 0.3); transform: scale(1.02); }
        .radio-item:has(input:checked)::before, .check-item:has(input:checked)::before { content: 'âœ”'; margin-right: 4px; font-size: 0.85rem; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }

        button { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .save-btn { background: var(--success); color: white; margin-top: 15px; padding: 12px; font-size: 0.9rem; }
        .add-btn { background: #495057; color: white; margin-bottom: 8px; }
        .clear-btn { background: #f1f3f5; color: #adb5bd; margin-bottom: 8px; padding: 10px; font-size: 0.8rem; }
        .calc-btn { background: var(--primary); color: white; margin-top: 5px; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3); }
        .image-btn { background: #6c5ce7; color: white; margin-top: 15px; }

        .result-box { background: var(--dark); color: #fff; padding: 20px; border-radius: 18px; display: none; margin-top: 15px; }
        .report-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.75rem; color: #ddd; }
        .report-table th { border-bottom: 1px solid #555; padding: 5px; text-align: left; }
        .report-table td { padding: 5px; border-bottom: 1px solid #444; }
        .highlight { color: #f39c12; font-weight: bold; }
        .text-red { color: #ff6b6b; font-weight: bold; }
        .text-green { color: #2ecc71; font-weight: bold; }
        .guide-container { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #444; }
        .guide-team { font-size: 0.85rem; margin-bottom: 4px; display: block; color: #f39c12; font-weight: bold; }
        .guide-detail { font-size: 0.8rem; color: #fff; display: flex; justify-content: flex-start; align-items: center; gap: 5px; }
        .send-label { font-size: 0.7rem; color: #aaa; background: #444; padding: 2px 6px; border-radius: 4px; }
        .detail-breakdown { font-size: 0.75rem; color: #bbb; margin-top: 5px; padding-left: 10px; border-left: 2px solid #555; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-card { background: #fff; width: 90%; max-width: 400px; padding: 20px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto; }
        .modal-title { margin-top: 0; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .setting-section { margin-bottom: 20px; }
        .setting-label { font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; display: block; color: #555; }
        .input-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .input-row input { margin: 0; padding: 8px; font-size: 0.85rem; }
        .del-btn { background: #ff4d4f; color: white; width: 40px; padding: 0; border-radius: 8px; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }
        .add-small-btn { background: #eee; color: #333; font-size: 0.8rem; padding: 8px; margin-top: 5px; }
        .modal-close-btn { background: var(--dark); color: white; margin-top: 10px; }
        .radio-wrapper { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h1 class="app-title">ğŸ§¾ íŒ€ ì •ì‚° ì–´í”Œ</h1>
        <button class="setting-btn" onclick="openSettings()" aria-label="ì„¤ì •">âš™ï¸</button>
    </div>

    <div class="card">
        <div id="itemList"></div>
        <button class="add-btn" onclick="addNewItem()">+ ìƒˆë¡œìš´ ì°¨ìˆ˜ ì¶”ê°€</button>
        <button class="clear-btn" onclick="clearAllItems()">ğŸ—‘ï¸ ëª¨ë“  ë‚´ì—­ ì§€ìš°ê¸°</button>
        <button class="calc-btn" onclick="calculate()">ğŸš€ ì •ì‚° ê²°ê³¼ í™•ì¸</button>
    </div>

    <div id="captureArea">
        <div id="result" class="result-box card">
            <h3 style="color:white; margin-top:0; text-align:center; font-size:1.1rem;">ğŸ“Š ìµœì¢… ì •ì‚° ë¦¬í¬íŠ¸</h3>
            <div id="reportHeader"></div>
            <div id="reportGuide"></div>
            <div id="privateSection"></div>
        </div>
    </div>
    
    <div id="actionButtons" style="display:none;">
        <button class="image-btn" onclick="saveAsImage()">ğŸ–¼ï¸ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-card">
        <h3 class="modal-title">âš™ï¸ ì„¤ì • ê´€ë¦¬</h3>
        
        <div class="setting-section">
            <span class="setting-label">ğŸ‘¥ ì „ì²´ íŒ€ ê´€ë¦¬</span>
            <div style="font-size:0.75rem; color:#888; margin-bottom:8px;">* ì°¸ì—¬í•˜ëŠ” ëª¨ë“  íŒ€ì„ ì…ë ¥í•˜ì„¸ìš”. <br>* 'ë‚´ë¶€ ì •ì‚°'ì€ ìš°ë¦¬ íŒ€ í•˜ë‚˜ë§Œ ì„ íƒí•˜ì„¸ìš”.</div>
            <div id="teamSettingList"></div>
            <button class="add-small-btn" onclick="addTeamInput()">+ íŒ€ ì¶”ê°€í•˜ê¸°</button>
        </div>

        <div class="setting-section">
            <span class="setting-label">ğŸ‘¤ ìš°ë¦¬ íŒ€ì› ê´€ë¦¬ (ë‚´ë¶€ ì •ì‚°ìš©)</span>
            <div style="font-size:0.75rem; color:#888; margin-bottom:8px;">* ìš°ë¦¬ íŒ€ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”. (ê°œë³„ ê²°ì œì)</div>
            <div id="memberSettingList"></div>
            <button class="add-small-btn" onclick="addMemberInput()">+ íŒ€ì› ì¶”ê°€í•˜ê¸°</button>
        </div>

        <button class="modal-close-btn" onclick="saveSettings()">ì €ì¥í•˜ê³  ë‹«ê¸°</button>
    </div>
</div>

<script>
    const defaultConfig = {
        teams: [
            { id: 'teamA', name: "AíŒ€(ì˜ì„±,ì§€í˜œ)", isMyTeam: false },
            { id: 'teamB', name: "BíŒ€(í˜„ìˆ˜,ë¯¸ì˜)", isMyTeam: false },
            { id: 'teamC', name: "CíŒ€(ì§€í›ˆ,ì€í˜œ)", isMyTeam: true }
        ],
        members: ["ì§€í›ˆ", "ì€í˜œ"] 
    };

    let appConfig = JSON.parse(localStorage.getItem('appConfig')) || defaultConfig;

    window.onload = function() {
        loadData();
    }

    function openSettings() {
        renderSettingsUI();
        document.getElementById('settingsModal').style.display = 'flex';
    }

    function renderSettingsUI() {
        const teamList = document.getElementById('teamSettingList');
        teamList.innerHTML = '';
        appConfig.teams.forEach((team, idx) => {
            const div = document.createElement('div');
            div.className = 'input-row';
            div.innerHTML = `
                <div class="radio-wrapper" style="flex:1;">
                    <input type="radio" name="myTeamSelect" ${team.isMyTeam ? 'checked' : ''} onclick="updateMyTeam(${idx})">
                    <input type="text" value="${team.name}" onchange="appConfig.teams[${idx}].name = this.value">
                </div>
                ${appConfig.teams.length > 1 ? `<button class="del-btn" onclick="removeTeam(${idx})">Ã—</button>` : ''}
            `;
            teamList.appendChild(div);
        });

        const memberList = document.getElementById('memberSettingList');
        memberList.innerHTML = '';
        appConfig.members.forEach((mem, idx) => {
            const div = document.createElement('div');
            div.className = 'input-row';
            div.innerHTML = `
                <input type="text" value="${mem}" onchange="appConfig.members[${idx}] = this.value" style="flex:1;">
                ${appConfig.members.length > 1 ? `<button class="del-btn" onclick="removeMember(${idx})">Ã—</button>` : ''}
            `;
            memberList.appendChild(div);
        });
    }

    function addTeamInput() {
        appConfig.teams.push({ id: `team${Date.now()}`, name: "ìƒˆë¡œìš´íŒ€", isMyTeam: false });
        renderSettingsUI();
    }

    function removeTeam(idx) {
        if(confirm('ì´ íŒ€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            appConfig.teams.splice(idx, 1);
            if(!appConfig.teams.some(t=>t.isMyTeam) && appConfig.teams.length > 0) appConfig.teams[0].isMyTeam = true;
            renderSettingsUI();
        }
    }

    function updateMyTeam(idx) {
        appConfig.teams.forEach((t, i) => t.isMyTeam = (i === idx));
    }

    function addMemberInput() {
        appConfig.members.push("ìƒˆíŒ€ì›");
        renderSettingsUI();
    }

    function removeMember(idx) {
        appConfig.members.splice(idx, 1);
        renderSettingsUI();
    }

    function saveSettings() {
        localStorage.setItem('appConfig', JSON.stringify(appConfig));
        document.getElementById('settingsModal').style.display = 'none';
        saveToLocal();
        location.reload(); 
    }

    function loadData() {
        const savedData = localStorage.getItem('settlementData');
        if (savedData) {
            JSON.parse(savedData).forEach((item) => renderItem(item));
        } else {
            addNewItem();
        }
    }

    function renderItem(data = null) {
        const tempId = Date.now() + Math.random();
        const div = document.createElement('div');
        div.className = `item-group ${data?.collapsed ? 'collapsed' : ''}`;
        div.setAttribute('data-id', tempId);
        
        const myTeam = appConfig.teams.find(t => t.isMyTeam);
        const otherTeams = appConfig.teams.filter(t => !t.isMyTeam);
        
        let payerOptionsHtml = otherTeams.map(t => 
            `<label class="radio-item"><input type="radio" name="payer_${tempId}" value="${t.name}" ${data?.payer === t.name ? 'checked' : ''} onchange="updateHeader(this)">${t.name}</label>`
        ).join('');
        
        payerOptionsHtml += appConfig.members.map(m => 
            `<label class="radio-item"><input type="radio" name="payer_${tempId}" value="${m}" ${data?.payer === m ? 'checked' : ''} onchange="updateHeader(this)">${m}</label>`
        ).join('');

        const teamCheckHtml = appConfig.teams.map(t => 
            `<label class="check-item"><input type="checkbox" class="team-check" value="${t.id}" data-name="${t.name}" ${data?.teams?.[t.id] !== false ? 'checked' : ''} onchange="updateHeader(this)">${t.name}</label>`
        ).join('');

        div.innerHTML = `
            <button class="remove-btn" onclick="removeItem(this)">Ã—</button>
            <div class="item-header" onclick="toggleItem(this)">
                <span style="font-weight:bold; font-size:0.9rem;" class="title-text">...</span>
                <div class="sub-text"></div>
            </div>
            <div class="item-body">
                <input type="text" placeholder="í•­ëª©ëª… (ì˜ˆ: ê°ìíƒ•)" class="item-name" value="${data?.name || ''}" oninput="updateHeader(this)">
                <input type="text" placeholder="ê²°ì œ ê¸ˆì•¡" class="item-amount" inputmode="numeric" value="${data?.amount || ''}" oninput="formatAmount(this); updateHeader(this)">
                <span class="label-text">ğŸ’³ ëˆ„ê°€ ê²°ì œí–ˆë‚˜ìš”? (í•„ìˆ˜)</span>
                <div class="flex-group">${payerOptionsHtml}</div>
                <span class="label-text">ğŸ‘¥ ì°¸ì—¬í•œ íŒ€ ì„ íƒ</span>
                <div class="flex-group">${teamCheckHtml}</div>
                <button class="save-btn" onclick="saveAndCollapse(this)">âœ” ì´ ë‚´ì—­ ì €ì¥ ë° ì ‘ê¸°</button>
            </div>
        `;
        document.getElementById('itemList').appendChild(div);
        updateHeader(div.querySelector('.item-name'));
    }

    function updateHeader(element) {
        const g = element.closest('.item-group');
        const nameInput = g.querySelector('.item-name').value;
        const amt = g.querySelector('.item-amount').value || "0";
        const payer = g.querySelector(`input[type="radio"]:checked`)?.nextSibling.textContent || "ë¯¸ì„ íƒ";
        
        const checkedTeams = Array.from(g.querySelectorAll('.team-check:checked')).map(cb => cb.getAttribute('data-name'));
        
        const allGroups = Array.from(document.querySelectorAll('.item-group'));
        const index = allGroups.indexOf(g) + 1;
        const finalName = nameInput || index + "ì°¨";
        
        g.querySelector('.title-text').innerText = `${finalName} (${amt}ì›)`;

        const teamStr = checkedTeams.length > 0 ? checkedTeams.join(', ') : "ì—†ìŒ";
        g.querySelector('.sub-text').innerHTML = `
            <div class="info-row"><span class="info-label">ğŸ’³ ê²°ì œ:</span> <span class="info-val">${payer}</span></div>
            <div class="info-row"><span class="info-label">ğŸ‘¥ ì°¸ì—¬:</span> <span class="info-val team-list">${teamStr}</span></div>
        `;
        saveToLocal();
    }

    function formatAmount(obj) {
        let value = obj.value.replace(/[^0-9]/g, "");
        obj.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function addNewItem() { renderItem(); }

    function clearAllItems() {
        if(confirm("ëª¨ë“  ì •ì‚° ë‚´ì—­ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem('settlementData');
            document.getElementById('itemList').innerHTML = "";
            document.getElementById('result').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            addNewItem();
        }
    }

    function saveAndCollapse(btn) {
        btn.closest('.item-group').classList.add('collapsed');
        saveToLocal();
    }

    function saveToLocal() {
        const items = [];
        document.querySelectorAll('.item-group').forEach(g => {
            const tempId = g.getAttribute('data-id');
            const teamChecks = {};
            g.querySelectorAll('.team-check').forEach(cb => {
                teamChecks[cb.value] = cb.checked;
            });

            items.push({
                name: g.querySelector('.item-name').value,
                amount: g.querySelector('.item-amount').value,
                payer: g.querySelector(`input[name="payer_${tempId}"]:checked`)?.value || "",
                teams: teamChecks,
                collapsed: g.classList.contains('collapsed')
            });
        });
        localStorage.setItem('settlementData', JSON.stringify(items));
    }

    function toggleItem(header) { header.closest('.item-group').classList.toggle('collapsed'); }
    function removeItem(btn) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { btn.closest('.item-group').remove(); saveToLocal(); } }

    function calculate() {
        saveToLocal();
        const items = JSON.parse(localStorage.getItem('settlementData') || "[]");
        const invalid = items.find(i => !i.payer || !i.amount || i.amount === "0");
        if (invalid) return alert("ê²°ì œ ì •ë³´ê°€ ëˆ„ë½ëœ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.");

        let total = 0;
        let teamPaid = {};
        let teamSpent = {};
        let memberPaid = {};
        
        appConfig.teams.forEach(t => {
            teamPaid[t.id] = 0;
            teamSpent[t.id] = 0;
        });
        appConfig.members.forEach(m => {
            memberPaid[m] = 0;
        });

        let tableHtml = `<table class="report-table"><tr><th>í•­ëª©</th><th>ê²°ì œì</th><th>ê¸ˆì•¡</th></tr>`;
        const myTeam = appConfig.teams.find(t => t.isMyTeam);

        items.forEach((item, idx) => {
            const amt = Number(item.amount.replace(/,/g,''));
            total += amt;
            tableHtml += `<tr><td>${item.name || (idx+1)+'ì°¨'}</td><td>${item.payer}</td><td>${amt.toLocaleString()}ì›</td></tr>`;

            if (appConfig.members.includes(item.payer)) {
                teamPaid[myTeam.id] += amt;
                memberPaid[item.payer] += amt;
            } else {
                const payerTeam = appConfig.teams.find(t => t.name === item.payer);
                if (payerTeam) {
                    teamPaid[payerTeam.id] += amt;
                }
            }

            const activeTeams = Object.keys(item.teams).filter(tid => item.teams[tid]);
            if (activeTeams.length > 0) {
                const perTeamCost = amt / activeTeams.length;
                activeTeams.forEach(tid => {
                    if (teamSpent[tid] !== undefined) teamSpent[tid] += perTeamCost;
                });
            }
        });

        let diffs = appConfig.teams.map(t => ({
            id: t.id,
            name: t.name,
            balance: teamPaid[t.id] - teamSpent[t.id]
        }));

        let msg = "";
        diffs.filter(d => d.balance < -1).forEach(debtor => {
            let debt = Math.abs(debtor.balance);
            diffs.filter(c => c.balance > 1).forEach(creditor => {
                if (debt <= 0 || creditor.balance <= 0) return;
                let amount = Math.min(debt, creditor.balance);
                
                msg += `<div class="guide-container">
                            <span class="guide-team">ğŸ’° ${debtor.name} â†’ ${creditor.name}</span>
                            <div class="guide-detail">
                                <span class="send-label">ë³´ë‚´ì•¼ í•  ëˆ</span>
                                <span class="highlight">${Math.round(amount).toLocaleString()}ì›</span>
                            </div>
                        </div>`;
                
                debt -= amount;
                creditor.balance -= amount;
            });
        });

        document.getElementById('reportHeader').innerHTML = `<div style="font-size:0.8rem; color:#bbb; border-bottom:1px solid #555; padding-bottom:5px;">ğŸ“ ì§€ì¶œ ë‚´ì—­</div>${tableHtml}<div style="text-align:right; font-weight:bold; margin:10px 0; color:#f39c12;">ì´ì•¡: ${total.toLocaleString()}ì›</div>`;
        document.getElementById('reportGuide').innerHTML = `<div style="font-size:0.8rem; color:#bbb; margin-bottom:8px;">ğŸ“ ìµœì¢… ì†¡ê¸ˆ ê°€ì´ë“œ</div><div style="background:#3d4446; padding:15px; border-radius:12px;">${msg || "ì •ì‚° ì™„ë£Œ (ì£¼ê³ ë°›ì„ ëˆ ì—†ìŒ)"}</div>`;
        
        const myTeamTotalSpent = teamSpent[myTeam.id];
        const perMemberShare = myTeamTotalSpent / appConfig.members.length;
        const netFlowC = teamPaid[myTeam.id] - teamSpent[myTeam.id];

        let internalSettlementHtml = "";
        let givers = [];
        let receivers = [];

        appConfig.members.forEach(m => {
            const diff = memberPaid[m] - perMemberShare;
            if (diff < -1) givers.push({name: m, amount: Math.abs(diff)});
            else if (diff > 1) receivers.push({name: m, amount: diff});
        });

        if (givers.length === 0 && receivers.length === 0) {
            internalSettlementHtml = "<div>ì •ì‚° ì™„ë£Œ (ì°¨ì•¡ ì—†ìŒ)</div>";
        } else {
            givers.forEach(g => {
                receivers.forEach(r => {
                    if (g.amount <= 0 || r.amount <= 0) return;
                    const trade = Math.min(g.amount, r.amount);
                    internalSettlementHtml += `<div>${g.name} â†’ ${r.name}: <span class="highlight">${Math.round(trade).toLocaleString()}ì›</span></div>`;
                    g.amount -= trade;
                    r.amount -= trade;
                });
            });
        }

        let optionBHtml = "";
        appConfig.members.forEach(m => {
            const take = memberPaid[m] - perMemberShare;
            optionBHtml += `<div style="margin-bottom:4px;">${getLabelAndValue(m, take)}</div>`;
        });

        const flowText = netFlowC >= 0 
            ? `ì™¸ë¶€ì—ì„œ <span class="text-green">${Math.round(netFlowC).toLocaleString()}ì›</span> ë°›ìŒ` 
            : `ì™¸ë¶€ë¡œ <span class="text-red">${Math.round(Math.abs(netFlowC)).toLocaleString()}ì›</span> ë³´ëƒ„`;

        let privateHtml = `<hr style="border:0; border-top:1px dashed #555; margin:15px 0;">
                           <div style="font-size:0.8rem; color:#bbb; margin-bottom:8px;">ğŸ“ ${myTeam.name} ë‚´ë¶€ ì •ì‚° (ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒ)</div>`;
        
        privateHtml += `<div style="margin-bottom:15px;">
                            <div style="font-size:0.75rem; color:#aaa; margin-bottom:4px;">ì˜µì…˜ A) ì™¸ë¶€ ì†¡ê¸ˆ ì „, ìš°ë¦¬ë¼ë¦¬ë§Œ ì •ì‚°</div>
                            <div style="font-size:0.85rem; color:#fff;">${internalSettlementHtml}</div>
                        </div>`;

        privateHtml += `<div>
                            <div style="font-size:0.75rem; color:#aaa; margin-bottom:4px;">ì˜µì…˜ B) ì™¸ë¶€ ì •ì‚°(${flowText}) í¬í•¨ ìµœì¢… ë¶„ë°°</div>
                            <div style="background:#3d4446; padding:10px; border-radius:8px; font-size:0.85rem;">
                                ${optionBHtml}
                            </div>
                        </div>`;

        document.getElementById('privateSection').innerHTML = privateHtml;
        
        document.getElementById('result').style.display = 'block';
        document.getElementById('actionButtons').style.display = 'block';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function getLabelAndValue(name, val) {
        if (val >= 0) {
            return `<div><span>${name} ì±™ê¸¸ ëˆ:</span> <span class="text-green">+${Math.round(val).toLocaleString()}ì›</span></div>`;
        } else {
            return `<div><span>${name} ë” ë‚¼ ëˆ:</span> <span class="text-red">${Math.round(Math.abs(val)).toLocaleString()}ì›</span></div>`;
        }
    }

    function saveAsImage() {
        const privateSection = document.getElementById('privateSection');
        privateSection.style.display = 'none';
        html2canvas(document.getElementById('captureArea'), { backgroundColor: "#f2f4f7", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `ì •ì‚°ë¦¬í¬íŠ¸_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL();
            link.click();
            privateSection.style.display = 'block';
        });
    }
</script>
</body>
</html>
